generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://macbookair:@localhost:5432/betzy_db?schema=public&pgbouncer=true"
}

enum TaskType {
  DAILY
  WEEKLY
  GENERAL
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

enum UserType {
  ADMIN
  CUSTOMER
}

enum GameTagStatus {
  NOT_APPLIED
  REQUESTED
  APPROVED
  REJECTED
}

enum NotificationType {
  PAYMENT_INITIATED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  TOPUP_COMPLETED
  WITHDRAWAL_APPROVED
  WITHDRAWAL_REJECTED
}

enum GameType {
  PLATFORM
  OFF_MARKET
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TOPUP
  PAYMENT
  REFUND
  REFERRAL_BONUS
  TASK_REWARD
}

model Membership {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  ordering       Int      @unique
  pointsRequired Int
  bonus          Float    @default(0.0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  users          User[]
}

model User {
  id           Int               @id @default(autoincrement())
  clerkId      String            @unique
  firstName    String?           @default("Anonymous")
  lastName     String?           @default("Anonymous")
  email        String            @unique
  profileUrl   String?
  xp           Float?            @default(0.0)
  balance      Float?            @default(0.0)
  lastSpinAt   DateTime?
  membershipId Int?
  referralCode String            @unique
  timezone     String?           @default("UTC")
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deletedAt    DateTime?
  gameTags     UserGameTag[]
  tasks        Task[]
  completions  Completion[]
  membership   Membership?       @relation(fields: [membershipId], references: [id], onDelete: SetNull)
  referredBy   Referral[]        @relation("Referrer")
  referrals    Referral[]        @relation("ReferredUser")
  Notification Notification[]
}

model Game {
  id             Int               @id @default(autoincrement())
  name           String
  gameType       GameType          @default(OFF_MARKET) // NEW: Game type
  game_link      String?
  image_id       Int?
  description    String?
  is_featured    Boolean?          @default(true)
  is_active      Boolean           @default(true)
  minTopupAmount Float?
  maxTopupAmount Float?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deletedAt      DateTime?
  tags           UserGameTag[]
  image          Gallery?          @relation(fields: [image_id], references: [id], onDelete: NoAction)

  @@index([gameType, is_active])
}

model UserGameTag {
  id        Int           @id @default(autoincrement())
  userId    Int
  gameId    Int
  gameTag   String        @unique
  password  String?
  status    GameTagStatus @default(NOT_APPLIED)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  User      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  Game      Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, gameTag])
  @@index([userId, gameId])
}

model Gallery {
  id        Int       @id @default(autoincrement())
  fileName  String
  url       String
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  game      Game[]
}

model MasterTask {
  id            Int      @id @default(autoincrement())
  title         String
  description   String?
  type          TaskType
  numberOfTimes Int      @default(1)
  reward        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tasks         Task[]
  @@unique([title, type])
}

model Task {
  id             Int          @id @default(autoincrement())
  userId         Int
  masterTaskId   Int
  completed      Boolean      @default(false)
  completedTimes Int          @default(0)
  completedAt    DateTime?
  resetAt        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  masterTask     MasterTask   @relation(fields: [masterTaskId], references: [id], onDelete: Cascade)
  completions    Completion[]

  @@unique([userId, masterTaskId])
  @@index([userId, completed])
  @@index([userId, masterTaskId, resetAt])
}

model Completion {
  id               Int      @id @default(autoincrement())
  taskId           Int
  userId           Int
  completedAt      DateTime @default(now())
  membershipPoints Int      @default(0)
  task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, taskId])
}

model Referral {
  id             Int      @id @default(autoincrement())
  referrerId     Int
  referredUserId Int
  referralCode   String
  bonusAwarded   Boolean  @default(false)
  bonusAmount    Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  referrer       User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUser   User     @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredUserId], map: "unique_referral")
  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
}

model Notification {
  id          Int              @id @default(autoincrement())
  title       String
  description String?
  type        NotificationType
  userId      Int
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, isRead])
}
